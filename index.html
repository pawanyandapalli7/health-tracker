<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Health OS â€” Pawan</title>
<meta name="theme-color" content="#f0c040">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Health OS">
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg: #07090e;
  --surface: #0d1017;
  --card: #111520;
  --card2: #161c2a;
  --border: #1c2233;
  --border2: #232d42;
  --gold: #f0c040;
  --gold2: #f5d060;
  --blue: #4d8ef5;
  --green: #3ecf82;
  --red: #f04f4f;
  --orange: #f08040;
  --purple: #9b6bda;
  --text: #e0e4f0;
  --muted: #4a5470;
  --muted2: #6b778f;
  --mono: 'DM Mono', monospace;
  --sans: 'DM Sans', sans-serif;
  --display: 'Syne', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html { scroll-behavior: smooth; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: var(--sans);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-screen {
  position: fixed; inset: 0;
  background: var(--bg);
  z-index: 999;
  display: flex; align-items: center; justify-content: center;
  padding: 1rem;
}
#login-screen.hidden { display: none; }

.login-box {
  width: 100%; max-width: 380px;
  background: var(--card);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 2.5rem 2rem;
  text-align: center;
}
.login-eyebrow { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; margin-bottom: 1rem; }
.login-box h1 { font-family: var(--display); font-size: 2rem; font-weight: 800; margin-bottom: 0.3rem; }
.login-box h1 span { color: var(--gold); }
.login-sub { font-size: 0.8rem; color: var(--muted2); margin-bottom: 2rem; }
.l-field { text-align: left; margin-bottom: 0.9rem; }
.l-field label { display: block; font-family: var(--mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.35rem; }
.l-field input { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: var(--mono); font-size: 0.82rem; padding: 0.65rem 1rem; outline: none; transition: border-color 0.2s; }
.l-field input:focus { border-color: var(--gold); }
.l-field input::placeholder { color: var(--muted); }
.login-err { font-family: var(--mono); font-size: 0.72rem; color: var(--red); margin-top: 0.5rem; display: none; }
.login-err.show { display: block; }
.login-btn { width: 100%; margin-top: 1.2rem; background: var(--gold); color: #000; border: none; border-radius: 10px; padding: 0.85rem; font-family: var(--display); font-weight: 700; font-size: 0.95rem; cursor: pointer; letter-spacing: 0.5px; transition: opacity 0.2s; }
.login-btn:hover { opacity: 0.88; }
@keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-8px)} 40%{transform:translateX(8px)} 60%{transform:translateX(-5px)} 80%{transform:translateX(5px)} }
.login-btn.shake { animation: shake 0.4s ease; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GITHUB SETUP MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay { position: fixed; inset: 0; background: rgba(7,9,14,0.92); backdrop-filter: blur(8px); z-index: 500; display: flex; align-items: center; justify-content: center; padding: 1rem; }
.overlay.hidden { display: none; }
.modal { background: var(--card); border: 1px solid var(--border2); border-radius: 16px; padding: 2rem; max-width: 460px; width: 100%; }
.modal h2 { font-family: var(--display); font-size: 1.3rem; font-weight: 700; margin-bottom: 0.4rem; }
.modal p { font-size: 0.8rem; color: var(--muted2); margin-bottom: 1.5rem; line-height: 1.6; }
.m-field { margin-bottom: 0.9rem; }
.m-field label { display: block; font-family: var(--mono); font-size: 0.65rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.35rem; }
.m-field input { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: var(--mono); font-size: 0.8rem; padding: 0.6rem 1rem; outline: none; transition: border-color 0.2s; }
.m-field input:focus { border-color: var(--gold); }
.m-field input::placeholder { color: var(--muted); }
.field-hint { font-size: 0.7rem; color: var(--muted); margin-top: 0.3rem; line-height: 1.5; }
.field-hint a { color: var(--blue); text-decoration: none; }
.modal-err { font-size: 0.75rem; color: var(--red); font-family: var(--mono); margin-top: 0.6rem; display: none; }
.btn-primary { background: var(--gold); color: #000; border: none; border-radius: 8px; padding: 0.72rem 1.5rem; font-weight: 700; font-size: 0.85rem; cursor: pointer; font-family: var(--display); transition: opacity 0.2s; width: 100%; margin-top: 1.2rem; }
.btn-primary:hover { opacity: 0.88; }
.btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
nav {
  display: flex; align-items: center; justify-content: space-between;
  padding: 0.9rem 1.5rem;
  border-bottom: 1px solid var(--border);
  background: rgba(7,9,14,0.96);
  backdrop-filter: blur(16px);
  position: sticky; top: 0; z-index: 100;
  flex-wrap: wrap; gap: 0.6rem;
}
.nav-logo { font-family: var(--display); font-size: 1rem; font-weight: 800; color: var(--gold); letter-spacing: -0.5px; }
.nav-logo span { color: var(--muted2); font-weight: 400; font-size: 0.75rem; margin-left: 0.4rem; font-family: var(--mono); }

.nav-tabs { display: flex; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.nav-tab { padding: 0.42rem 1rem; font-size: 0.76rem; font-weight: 600; cursor: pointer; color: var(--muted2); transition: all 0.2s; border: none; background: transparent; font-family: var(--sans); }
.nav-tab.active { background: var(--gold); color: #000; }
.nav-tab:hover:not(.active) { color: var(--text); background: var(--border); }

.nav-right { display: flex; align-items: center; gap: 0.6rem; flex-wrap: wrap; }
.sync-pill { display: flex; align-items: center; gap: 0.35rem; font-family: var(--mono); font-size: 0.68rem; color: var(--muted2); }
.sdot { width: 5px; height: 5px; border-radius: 50%; background: var(--muted); transition: background 0.3s; }
.sdot.syncing { background: var(--gold); animation: blink 1s infinite; }
.sdot.synced { background: var(--green); }
.sdot.error { background: var(--red); }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

.icon-btn { background: transparent; border: 1px solid var(--border); color: var(--muted2); font-family: var(--mono); font-size: 0.68rem; padding: 0.32rem 0.7rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
.icon-btn:hover { border-color: var(--gold); color: var(--gold); }
.icon-btn.danger:hover { border-color: var(--red); color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEWS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.view { display: none; padding: 1.5rem; max-width: 1000px; margin: 0 auto; }
.view.active { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMMAND BAR (date + mode + tokens)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.command-bar {
  display: flex; align-items: center; gap: 0.75rem;
  margin-bottom: 1.25rem; flex-wrap: wrap;
}

.date-ctrl { display: flex; align-items: center; gap: 0.4rem; background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 0.4rem 0.75rem; }
.d-btn { background: none; border: none; color: var(--muted2); cursor: pointer; font-size: 1rem; line-height: 1; transition: color 0.15s; padding: 0 0.1rem; }
.d-btn:hover { color: var(--gold); }
.d-btn:disabled { opacity: 0.2; cursor: default; }
#date-picker { background: transparent; border: none; color: var(--gold); font-family: var(--mono); font-size: 0.76rem; outline: none; cursor: pointer; }
#date-picker::-webkit-calendar-picker-indicator { filter: invert(0.4) sepia(1) saturate(4) hue-rotate(5deg); cursor: pointer; }
.today-badge { background: var(--gold); color: #000; font-family: var(--mono); font-size: 0.6rem; font-weight: 700; border-radius: 4px; padding: 1px 5px; letter-spacing: 0.5px; }

.mode-selector { position: relative; }
.mode-btn { display: flex; align-items: center; gap: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 0.4rem 0.9rem; cursor: pointer; font-size: 0.78rem; font-weight: 600; transition: border-color 0.2s; white-space: nowrap; }
.mode-btn:hover { border-color: var(--gold); }
.mode-dot { width: 8px; height: 8px; border-radius: 50%; }
.mode-menu { position: absolute; top: calc(100% + 6px); left: 0; background: var(--card2); border: 1px solid var(--border2); border-radius: 10px; padding: 0.4rem; min-width: 180px; z-index: 50; display: none; box-shadow: 0 12px 40px rgba(0,0,0,0.5); }
.mode-menu.open { display: block; }
.mode-item { display: flex; align-items: center; gap: 0.7rem; padding: 0.55rem 0.8rem; border-radius: 7px; cursor: pointer; font-size: 0.82rem; transition: background 0.15s; }
.mode-item:hover { background: var(--border); }
.mode-item.active { background: rgba(240,192,64,0.1); }
.mode-item-name { flex: 1; font-weight: 500; }
.mode-item-desc { font-size: 0.7rem; color: var(--muted2); }

.grace-pill { display: flex; align-items: center; gap: 0.5rem; background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 0.4rem 0.9rem; font-family: var(--mono); font-size: 0.72rem; color: var(--muted2); white-space: nowrap; }
.grace-token { display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: var(--gold); opacity: 0.3; cursor: pointer; transition: opacity 0.2s; }
.grace-token.used { opacity: 0.1; }
.grace-token.available { opacity: 1; }
.grace-token:hover { opacity: 0.7; }

.copy-yesterday-btn { display: flex; align-items: center; gap: 0.4rem; background: var(--card); border: 1px solid var(--border); border-radius: 9px; padding: 0.4rem 0.9rem; cursor: pointer; font-size: 0.76rem; color: var(--muted2); transition: all 0.2s; white-space: nowrap; font-family: var(--mono); }
.copy-yesterday-btn:hover { border-color: var(--blue); color: var(--blue); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TODAY'S FOCUS CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.focus-card {
  background: linear-gradient(135deg, rgba(240,192,64,0.08) 0%, rgba(77,142,245,0.05) 100%);
  border: 1px solid rgba(240,192,64,0.25);
  border-radius: 16px;
  padding: 1.25rem 1.5rem;
  margin-bottom: 1rem;
  display: flex; align-items: center; gap: 1.2rem;
}
.focus-icon { font-size: 2rem; flex-shrink: 0; }
.focus-eyebrow { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 2px; color: var(--gold); text-transform: uppercase; margin-bottom: 0.3rem; }
.focus-text { font-family: var(--display); font-size: 1.1rem; font-weight: 700; line-height: 1.3; }
.focus-why { font-size: 0.78rem; color: var(--muted2); margin-top: 0.25rem; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOMENTUM + STATS ROW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top-row { display: grid; grid-template-columns: auto 1fr; gap: 1rem; margin-bottom: 1rem; }

.momentum-card {
  background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 1.3rem 1.5rem;
  display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 160px;
  position: relative; overflow: hidden;
}
.momentum-card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 50% 120%, rgba(240,192,64,0.08) 0%, transparent 70%); pointer-events: none; }
.momentum-eyebrow { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 2px; color: var(--muted); text-transform: uppercase; margin-bottom: 0.6rem; }
.momentum-score { font-family: var(--display); font-size: 3.5rem; font-weight: 800; line-height: 1; }
.momentum-score.thriving { color: var(--green); }
.momentum-score.stable { color: var(--gold); }
.momentum-score.risk { color: var(--red); }
.momentum-status { font-family: var(--mono); font-size: 0.72rem; margin-top: 0.35rem; letter-spacing: 1px; }
.momentum-status.thriving { color: var(--green); }
.momentum-status.stable { color: var(--gold); }
.momentum-status.risk { color: var(--red); }
.momentum-bar { width: 100%; height: 4px; background: var(--border2); border-radius: 100px; overflow: hidden; margin-top: 0.7rem; }
.momentum-bar-fill { height: 100%; border-radius: 100px; transition: width 0.8s cubic-bezier(.4,0,.2,1); }

.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
.stat-tile { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.1rem; }
.stat-tile-label { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.4rem; }
.stat-tile-value { font-family: var(--display); font-size: 1.6rem; font-weight: 700; line-height: 1; }
.stat-tile-value.g { color: var(--green); }
.stat-tile-value.b { color: var(--blue); }
.stat-tile-value.o { color: var(--orange); }
.stat-tile-sub { font-size: 0.7rem; color: var(--muted2); margin-top: 0.25rem; display: flex; align-items: center; gap: 0.3rem; }
.trend { font-size: 0.75rem; font-weight: 700; }
.trend.up { color: var(--green); }
.trend.flat { color: var(--muted2); }
.trend.down { color: var(--red); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOOD + ENERGY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mood-row { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem; }
.mood-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.2rem; }
.mood-label { font-family: var(--mono); font-size: 0.62rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.75rem; }
.rating-dots { display: flex; gap: 0.5rem; }
.rdot { width: 32px; height: 32px; border-radius: 8px; border: 1.5px solid var(--border2); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; font-family: var(--mono); color: var(--muted); transition: all 0.18s; flex-shrink: 0; position: relative; }
.rdot:hover { border-color: var(--gold); color: var(--gold); transform: scale(1.1); }
.rdot:hover::after { content: attr(data-label); position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: var(--card2); border: 1px solid var(--border2); color: var(--text); font-size: 0.65rem; font-family: var(--mono); padding: 3px 8px; border-radius: 5px; white-space: nowrap; pointer-events: none; z-index: 20; letter-spacing: 0.5px; }
.rdot.sel { color: #000; border-color: transparent; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTIONS / CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sections { display: flex; flex-direction: column; gap: 0.65rem; margin-bottom: 1rem; }

.section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: border-color 0.3s; }
.section.complete { border-color: rgba(62,207,130,0.3); }

.sec-hdr { display: flex; align-items: center; gap: 0.65rem; padding: 0.75rem 1.1rem; cursor: pointer; user-select: none; }
.sec-hdr:hover { background: rgba(255,255,255,0.02); }
.sec-ico { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 7px; background: rgba(255,255,255,0.04); font-size: 0.9rem; flex-shrink: 0; }
.sec-meta { flex: 1; }
.sec-name { font-size: 0.85rem; font-weight: 600; }
.sec-time { font-size: 0.67rem; color: var(--muted); font-family: var(--mono); }
.sec-prog { display: flex; align-items: center; gap: 0.45rem; }
.sec-bw { width: 50px; height: 3px; background: var(--border2); border-radius: 100px; overflow: hidden; }
.sec-bf { height: 100%; border-radius: 100px; transition: width 0.4s; }
.sec-cnt { font-family: var(--mono); font-size: 0.68rem; color: var(--muted2); min-width: 26px; text-align: right; }
.chev { color: var(--muted); font-size: 0.6rem; transition: transform 0.2s; }
.section.collapsed .chev { transform: rotate(-90deg); }

.sec-body { padding: 0.2rem 0 0.5rem; border-top: 1px solid var(--border); }
.section.collapsed .sec-body { display: none; }

.sublbl { font-size: 0.62rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); padding: 0.4rem 1.1rem 0.15rem; font-family: var(--mono); }
.hdivider { border: none; border-top: 1px solid var(--border); margin: 0.3rem 1.1rem; }

.item { display: flex; align-items: flex-start; gap: 0.72rem; padding: 0.48rem 1.1rem; cursor: pointer; transition: background 0.1s; }
.item:hover { background: rgba(255,255,255,0.022); }
.item.checked { opacity: 0.32; }
.item.checked .item-txt { text-decoration: line-through; color: var(--muted); }

.cb { width: 16px; height: 16px; border: 1.5px solid var(--border2); border-radius: 4px; flex-shrink: 0; margin-top: 2px; display: flex; align-items: center; justify-content: center; transition: all 0.18s; }
.item.checked .cb { background: var(--green); border-color: var(--green); }
.cb svg { display: none; width: 9px; height: 9px; stroke: #fff; stroke-width: 2.5; fill: none; }
.item.checked .cb svg { display: block; }

.item-txt { font-size: 0.82rem; line-height: 1.5; }
.item-note { font-size: 0.68rem; color: var(--muted); margin-top: 1px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM TOOLS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.tools-bar { display: flex; align-items: center; justify-content: space-between; padding-top: 1rem; border-top: 1px solid var(--border); flex-wrap: wrap; gap: 0.75rem; margin-bottom: 2rem; }
.save-pill { display: flex; align-items: center; gap: 0.35rem; font-family: var(--mono); font-size: 0.7rem; color: var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NOTES VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.note-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; margin-bottom: 1rem; }
.note-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.8rem; }
.note-date-lbl { font-family: var(--mono); font-size: 0.75rem; color: var(--gold); }
textarea.note-ta { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: var(--sans); font-size: 0.85rem; padding: 0.85rem; resize: vertical; min-height: 110px; outline: none; transition: border-color 0.2s; line-height: 1.6; }
textarea.note-ta:focus { border-color: var(--blue); }
textarea.note-ta::placeholder { color: var(--muted); }
.note-save-btn { margin-top: 0.6rem; background: var(--blue); color: #fff; border: none; border-radius: 7px; padding: 0.55rem 1.2rem; font-size: 0.8rem; font-weight: 600; cursor: pointer; font-family: var(--sans); transition: opacity 0.2s; }
.note-save-btn:hover { opacity: 0.85; }
.past-notes { display: flex; flex-direction: column; gap: 0.65rem; }
.past-note { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0.85rem 1rem; }
.pn-date { font-family: var(--mono); font-size: 0.65rem; color: var(--muted); margin-bottom: 0.35rem; }
.pn-text { font-size: 0.82rem; line-height: 1.6; color: var(--muted2); white-space: pre-wrap; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-section-title { font-family: var(--mono); font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase; color: var(--muted); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; }
.dash-section-title::before { content: ''; display: inline-block; width: 5px; height: 5px; border-radius: 50%; background: var(--gold); }

.chart-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.3rem; margin-bottom: 1rem; }

.bar-chart { display: flex; align-items: flex-end; gap: 3px; height: 100px; position: relative; }
.bar-chart::before { content: ''; position: absolute; left:0;right:0;top:0;bottom:0; background: repeating-linear-gradient(transparent,transparent calc(25% - 1px),var(--border) calc(25% - 1px),var(--border) 25%); pointer-events: none; }
.bcol { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; height: 100%; justify-content: flex-end; }
.bbar { width: 100%; border-radius: 3px 3px 0 0; min-height: 2px; cursor: pointer; position: relative; transition: opacity 0.15s; }
.bbar:hover { opacity: 0.75; }
.bbar:hover::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 5px); left: 50%; transform: translateX(-50%); background: var(--card2); border: 1px solid var(--border2); color: var(--text); font-size: 0.65rem; font-family: var(--mono); padding: 3px 7px; border-radius: 4px; white-space: nowrap; z-index: 10; pointer-events: none; }
.blbl { font-family: var(--mono); font-size: 0.56rem; color: var(--muted); text-align: center; width: 100%; }

.two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }

.cat-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.7rem; }
.cat-name { font-size: 0.78rem; width: 85px; flex-shrink: 0; }
.cat-bw { flex: 1; height: 5px; background: var(--border2); border-radius: 100px; overflow: hidden; }
.cat-bf { height: 100%; border-radius: 100px; transition: width 0.6s cubic-bezier(.4,0,.2,1); }
.cat-pct { font-family: var(--mono); font-size: 0.7rem; color: var(--muted2); width: 32px; text-align: right; }

.missed-row { display: flex; align-items: center; gap: 0.7rem; padding: 0.45rem 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 0.45rem; }
.missed-name { font-size: 0.78rem; flex: 2; }
.missed-bw { flex: 1; height: 3px; background: var(--border2); border-radius: 100px; overflow: hidden; }
.missed-bf { height: 100%; border-radius: 100px; background: var(--red); opacity: 0.7; }
.missed-fix { font-size: 0.7rem; color: var(--blue); flex-shrink: 0; font-family: var(--mono); }
.missed-pct { font-family: var(--mono); font-size: 0.7rem; color: var(--red); width: 30px; text-align: right; }

.heatmap { display: grid; grid-template-columns: repeat(30,1fr); gap: 3px; }
.hcell { aspect-ratio: 1; border-radius: 3px; cursor: pointer; position: relative; transition: transform 0.1s; }
.hcell:hover { transform: scale(1.4); z-index: 5; }
.hcell:hover::after { content: attr(data-tip); position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%); background: var(--card2); border: 1px solid var(--border2); color: var(--text); font-size: 0.63rem; font-family: var(--mono); padding: 2px 6px; border-radius: 4px; white-space: nowrap; z-index: 10; pointer-events: none; }

.heat-legend { display: flex; align-items: center; gap: 0.35rem; margin-top: 0.5rem; font-size: 0.65rem; color: var(--muted); font-family: var(--mono); }
.lc { width: 9px; height: 9px; border-radius: 2px; }

/* weekly summary */
.weekly-summary { background: linear-gradient(135deg, rgba(77,142,245,0.07) 0%, rgba(62,207,130,0.04) 100%); border: 1px solid rgba(77,142,245,0.2); border-radius: 14px; padding: 1.3rem; margin-bottom: 1rem; }
.ws-title { font-family: var(--display); font-size: 1rem; font-weight: 700; margin-bottom: 0.3rem; color: var(--blue); }
.ws-body { font-size: 0.83rem; color: var(--muted2); line-height: 1.75; }
.ws-body strong { color: var(--text); }
.ws-focus { margin-top: 0.9rem; padding: 0.75rem 1rem; background: rgba(240,192,64,0.08); border: 1px solid rgba(240,192,64,0.2); border-radius: 9px; }
.ws-focus-label { font-family: var(--mono); font-size: 0.62rem; letter-spacing: 1.5px; color: var(--gold); text-transform: uppercase; margin-bottom: 0.25rem; }
.ws-focus-text { font-size: 0.85rem; font-weight: 600; }

.empty-state { text-align: center; padding: 1.5rem; color: var(--muted); font-size: 0.8rem; font-family: var(--mono); }

/* mood chart */
.mood-timeline { display: flex; align-items: flex-end; gap: 4px; height: 60px; }
.mood-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 3px; height: 100%; justify-content: flex-end; }
.mood-bar { width: 100%; border-radius: 3px 3px 0 0; min-height: 2px; }
.mood-blbl { font-family: var(--mono); font-size: 0.55rem; color: var(--muted); text-align: center; }

/* â”€â”€ CONFETTI â”€â”€ */
#confetti-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 9999; display: none; }

/* â”€â”€ INSTALL BANNER â”€â”€ */
.install-banner {
  display: none; align-items: center; justify-content: space-between;
  background: linear-gradient(135deg, rgba(240,192,64,0.1), rgba(77,142,245,0.08));
  border: 1px solid rgba(240,192,64,0.25); border-radius: 12px;
  padding: 0.75rem 1.1rem; margin-bottom: 1rem; gap: 0.75rem; flex-wrap: wrap;
}
.install-banner.show { display: flex; }
.install-banner-text { font-size: 0.82rem; }
.install-banner-text strong { color: var(--gold); }
.install-btn { background: var(--gold); color: #000; border: none; border-radius: 7px; padding: 0.45rem 1rem; font-weight: 700; font-size: 0.78rem; cursor: pointer; font-family: var(--display); }

/* â”€â”€ WEIGHT TAB â”€â”€ */
.weight-input-row { display: flex; gap: 0.75rem; align-items: flex-end; margin-bottom: 1.25rem; flex-wrap: wrap; }
.w-field { flex: 1; min-width: 120px; }
.w-field label { display: block; font-family: var(--mono); font-size: 0.62rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.35rem; }
.w-field input { width: 100%; background: var(--surface); border: 1px solid var(--border2); border-radius: 8px; color: var(--text); font-family: var(--mono); font-size: 0.88rem; padding: 0.6rem 0.9rem; outline: none; transition: border-color 0.2s; }
.w-field input:focus { border-color: var(--gold); }
.w-log-btn { background: var(--gold); color: #000; border: none; border-radius: 8px; padding: 0.65rem 1.3rem; font-weight: 700; font-size: 0.82rem; cursor: pointer; font-family: var(--display); transition: opacity 0.2s; white-space: nowrap; }
.w-log-btn:hover { opacity: 0.85; }

.weight-chart-wrap { position: relative; height: 140px; margin-bottom: 1rem; }
.weight-svg { width: 100%; height: 100%; overflow: visible; }

.weight-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 0.75rem; margin-bottom: 1.25rem; }
.w-stat { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 0.85rem 1rem; }
.w-stat-label { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.3rem; }
.w-stat-value { font-family: var(--display); font-size: 1.4rem; font-weight: 700; }
.w-stat-sub { font-size: 0.68rem; color: var(--muted2); margin-top: 0.2rem; }

.weight-log { display: flex; flex-direction: column; gap: 0.4rem; max-height: 220px; overflow-y: auto; }
.weight-log::-webkit-scrollbar { width: 3px; }
.weight-log::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
.w-entry { display: flex; align-items: center; justify-content: space-between; padding: 0.5rem 0.8rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; font-size: 0.8rem; }
.w-entry-date { font-family: var(--mono); font-size: 0.7rem; color: var(--muted2); }
.w-entry-val { font-family: var(--display); font-weight: 700; }
.w-entry-delta { font-family: var(--mono); font-size: 0.7rem; }
.w-del-btn { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.75rem; padding: 0 0.25rem; transition: color 0.15s; }
.w-del-btn:hover { color: var(--red); }

/* â”€â”€ RECORDS â”€â”€ */
.records-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 0.75rem; margin-bottom: 1.25rem; }
.record-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.1rem; text-align: center; position: relative; overflow: hidden; }
.record-card::before { content: ''; position: absolute; inset: 0; background: radial-gradient(circle at 50% 0%, rgba(240,192,64,0.06) 0%, transparent 70%); pointer-events: none; }
.record-trophy { font-size: 1.5rem; margin-bottom: 0.35rem; }
.record-label { font-family: var(--mono); font-size: 0.6rem; color: var(--muted); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 0.3rem; }
.record-value { font-family: var(--display); font-size: 1.8rem; font-weight: 800; color: var(--gold); line-height: 1; }
.record-sub { font-size: 0.7rem; color: var(--muted2); margin-top: 0.25rem; }

/* â”€â”€ CORRELATION â”€â”€ */
.corr-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.1rem 1.25rem; margin-bottom: 0.6rem; display: flex; align-items: flex-start; gap: 1rem; }
.corr-icon { font-size: 1.4rem; flex-shrink: 0; margin-top: 0.1rem; }
.corr-title { font-size: 0.88rem; font-weight: 600; margin-bottom: 0.2rem; }
.corr-desc { font-size: 0.78rem; color: var(--muted2); line-height: 1.5; }
.corr-badge { display: inline-block; margin-top: 0.35rem; font-family: var(--mono); font-size: 0.68rem; padding: 2px 8px; border-radius: 4px; font-weight: 500; }
.corr-badge.pos { background: rgba(62,207,130,0.15); color: var(--green); }
.corr-badge.neg { background: rgba(240,79,79,0.12); color: var(--red); }
.corr-badge.neu { background: rgba(77,142,245,0.12); color: var(--blue); }

@media (max-width: 680px) {
  .weight-stats { grid-template-columns: repeat(2,1fr); }
  .records-grid { grid-template-columns: repeat(2,1fr); }
}

@media (max-width: 680px) {
  .top-row { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: repeat(3,1fr); }
  .mood-row { grid-template-columns: 1fr; }
  .two-col { grid-template-columns: 1fr; }
  .heatmap { grid-template-columns: repeat(15,1fr); }
  .command-bar { gap: 0.5rem; }
  nav { padding: 0.75rem 1rem; }
  .view { padding: 1rem; }
}
</style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>

<!-- â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-eyebrow">PY Â· Health OS</div>
    <h1>Welcome <span>Back</span></h1>
    <p class="login-sub">Your personal health operating system</p>
    <div class="l-field">
      <label>Username</label>
      <input type="text" id="li-user" placeholder="Enter username" autocomplete="username" />
    </div>
    <div class="l-field">
      <label>Password</label>
      <input type="password" id="li-pass" placeholder="Enter password" autocomplete="current-password" />
    </div>
    <div class="login-err" id="login-err">âœ— Incorrect username or password</div>
    <button class="login-btn" id="login-btn" onclick="doLogin()">Sign In â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• GITHUB SETUP â•â•â•â•â•â•â• -->
<div class="overlay hidden" id="setup-overlay">
  <div class="modal">
    <h2>Connect GitHub Storage</h2>
    <p>Your data saves privately to your GitHub repo. You only need to do this once.</p>
    <div class="m-field">
      <label>Personal Access Token</label>
      <input type="password" id="cfg-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" />
      <div class="field-hint">Create at <a href="https://github.com/settings/tokens/new" target="_blank">github.com/settings/tokens</a> Â· Scope: <strong>repo</strong></div>
    </div>
    <div class="modal-err" id="modal-err"></div>
    <button class="btn-primary" id="cfg-save-btn" onclick="saveConfig()">Connect & Save</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â• -->
<nav>
  <div class="nav-logo">Health OS <span>/ pawan</span></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchView('today',this)">Today</button>
    <button class="nav-tab" onclick="switchView('dashboard',this)">Dashboard</button>
    <button class="nav-tab" onclick="switchView('weight',this)">Weight</button>
    <button class="nav-tab" onclick="switchView('records',this)">Records</button>
    <button class="nav-tab" onclick="switchView('notes',this)">Notes</button>
  </div>
  <div class="nav-right">
    <div class="sync-pill"><div class="sdot" id="sdot"></div><span id="slbl">â€”</span></div>
    <button class="icon-btn" onclick="openSettings()">âš™</button>
    <button class="icon-btn danger" onclick="doLogout()">â†©</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TODAY VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view active" id="view-today">

  <!-- Install Banner -->
  <div class="install-banner" id="install-banner">
    <div class="install-banner-text">ğŸ“± <strong>Install Health OS</strong> â€” add to your home screen for instant access</div>
    <button class="install-btn" onclick="triggerInstall()">Install App</button>
    <button class="icon-btn" onclick="document.getElementById('install-banner').classList.remove('show')" style="padding:0.3rem 0.6rem">âœ•</button>
  </div>

  <!-- Command Bar -->
  <div class="command-bar">
    <div class="date-ctrl">
      <button class="d-btn" id="prev-btn" onclick="shiftDay(-1)">â€¹</button>
      <input type="date" id="date-picker" onchange="onDateChange(this.value)" />
      <button class="d-btn" id="next-btn" onclick="shiftDay(1)">â€º</button>
      <span class="today-badge" id="today-badge" style="display:none">TODAY</span>
    </div>

    <div class="mode-selector" id="mode-selector">
      <div class="mode-btn" onclick="toggleModeMenu()">
        <div class="mode-dot" id="mode-dot"></div>
        <span id="mode-label">Maintenance</span>
        <span style="color:var(--muted);font-size:0.7rem">â–¾</span>
      </div>
      <div class="mode-menu" id="mode-menu"></div>
    </div>

    <div class="grace-pill">
      <span style="margin-right:0.2rem">Grace</span>
      <span class="grace-token" id="gt0" onclick="useGrace(0)" title="Grace token 1"></span>
      <span class="grace-token" id="gt1" onclick="useGrace(1)" title="Grace token 2"></span>
    </div>

    <button class="copy-yesterday-btn" onclick="copyYesterday()">â˜ Same as yesterday</button>
  </div>

  <!-- Today's Focus -->
  <div class="focus-card" id="focus-card">
    <div class="focus-icon" id="focus-icon">ğŸ¯</div>
    <div>
      <div class="focus-eyebrow">Today's Focus</div>
      <div class="focus-text" id="focus-text">Loading...</div>
      <div class="focus-why" id="focus-why"></div>
    </div>
  </div>

  <!-- Momentum + Stats -->
  <div class="top-row">
    <div class="momentum-card">
      <div class="momentum-eyebrow">Momentum</div>
      <div class="momentum-score" id="m-score">â€”</div>
      <div class="momentum-status" id="m-status"></div>
      <div class="momentum-bar"><div class="momentum-bar-fill" id="m-bar"></div></div>
    </div>
    <div class="stats-grid">
      <div class="stat-tile">
        <div class="stat-tile-label">Streak</div>
        <div class="stat-tile-value g" id="st-streak">0</div>
        <div class="stat-tile-sub"><span class="trend flat" id="st-streak-trend">â†’</span> days</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-label">7-Day Avg</div>
        <div class="stat-tile-value b" id="st-avg">0%</div>
        <div class="stat-tile-sub"><span class="trend flat" id="st-avg-trend">â†’</span> vs prior week</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-label">Today</div>
        <div class="stat-tile-value o" id="st-today">0%</div>
        <div class="stat-tile-sub" id="st-today-sub">0 / 0 tasks</div>
      </div>
    </div>
  </div>

  <!-- Mood + Energy -->
  <div class="mood-row">
    <div class="mood-card">
      <div class="mood-label">Mood Today</div>
      <div class="rating-dots" id="mood-dots"></div>
    </div>
    <div class="mood-card">
      <div class="mood-label">Energy Today</div>
      <div class="rating-dots" id="energy-dots"></div>
    </div>
  </div>

  <!-- Routine Sections -->
  <div class="sections" id="sections-container"></div>

  <div class="tools-bar">
    <div class="save-pill">
      <div class="sdot" id="save-dot"></div>
      <span id="save-lbl">ready</span>
    </div>
    <button class="icon-btn danger" onclick="resetDay()">â†º reset day</button>
  </div>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-dashboard">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem;flex-wrap:wrap;gap:0.75rem;">
    <div style="font-family:var(--display);font-size:1.5rem;font-weight:800">Health <span style="color:var(--gold)">Intelligence</span></div>
    <div style="font-family:var(--mono);font-size:0.68rem;color:var(--muted)">Last 30 days</div>
  </div>

  <div id="weekly-summary-wrap"></div>

  <div class="chart-card">
    <div class="dash-section-title">30-Day Momentum</div>
    <div class="bar-chart" id="momentum-chart"></div>
    <div style="display:flex;justify-content:space-between;margin-top:0.4rem;">
      <div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted)">30 days ago</div>
      <div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted)">Today</div>
    </div>
  </div>

  <div class="two-col">
    <div class="chart-card">
      <div class="dash-section-title">Category Breakdown</div>
      <div id="cat-breakdown"></div>
    </div>
    <div class="chart-card">
      <div class="dash-section-title">Mood & Energy (7 days)</div>
      <div style="margin-bottom:0.5rem;">
        <div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);margin-bottom:0.35rem">MOOD</div>
        <div class="mood-timeline" id="mood-chart"></div>
      </div>
      <div>
        <div style="font-family:var(--mono);font-size:0.6rem;color:var(--muted);margin-bottom:0.35rem">ENERGY</div>
        <div class="mood-timeline" id="energy-chart"></div>
      </div>
    </div>
  </div>

  <div class="two-col">
    <div class="chart-card">
      <div class="dash-section-title">Most Missed â†’ Fix</div>
      <div id="missed-list"></div>
    </div>
    <div class="chart-card">
      <div class="dash-section-title">Trend Signals</div>
      <div id="trend-signals"></div>
    </div>
  </div>

  <div class="chart-card">
    <div class="dash-section-title">Completion Heatmap</div>
    <div class="heatmap" id="heatmap"></div>
    <div class="heat-legend">
      <span>Less</span>
      <div class="lc" style="background:#141a24"></div>
      <div class="lc" style="background:#1e3020"></div>
      <div class="lc" style="background:#2a5030"></div>
      <div class="lc" style="background:#3ecf82;opacity:0.5"></div>
      <div class="lc" style="background:#3ecf82"></div>
      <span>More</span>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WEIGHT VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-weight">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;flex-wrap:wrap;gap:0.75rem;">
    <div style="font-family:var(--display);font-size:1.5rem;font-weight:800">Weight <span style="color:var(--gold)">Tracker</span></div>
    <div style="font-family:var(--mono);font-size:0.68rem;color:var(--muted)" id="weight-range-label">Last 30 days</div>
  </div>

  <!-- Input Row -->
  <div class="chart-card">
    <div class="weight-input-row">
      <div class="w-field">
        <label>Weight (kg)</label>
        <input type="number" id="w-input" placeholder="e.g. 72.5" step="0.1" min="30" max="200" />
      </div>
      <div class="w-field">
        <label>Date</label>
        <input type="date" id="w-date" />
      </div>
      <button class="w-log-btn" onclick="logWeight()">+ Log Weight</button>
    </div>

    <!-- Weight Stats -->
    <div class="weight-stats" id="weight-stats"></div>

    <!-- Chart -->
    <div class="dash-section-title">Trend</div>
    <div class="weight-chart-wrap">
      <svg class="weight-svg" id="weight-svg" viewBox="0 0 600 140" preserveAspectRatio="none"></svg>
    </div>
  </div>

  <!-- Log -->
  <div class="chart-card">
    <div class="dash-section-title">Log</div>
    <div class="weight-log" id="weight-log"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RECORDS VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-records">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;flex-wrap:wrap;gap:0.75rem;">
    <div style="font-family:var(--display);font-size:1.5rem;font-weight:800">Personal <span style="color:var(--gold)">Records</span></div>
  </div>

  <div class="records-grid" id="records-grid"></div>

  <div class="chart-card" style="margin-bottom:1rem;">
    <div class="dash-section-title">Correlation Engine</div>
    <div style="font-size:0.78rem;color:var(--muted2);margin-bottom:1rem;">Patterns discovered from your data. Updates as you log more days.</div>
    <div id="correlations"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     NOTES VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="view" id="view-notes">
  <div style="margin-bottom:1.25rem;">
    <div style="font-family:var(--display);font-size:1.5rem;font-weight:800">Daily <span style="color:var(--gold)">Notes</span></div>
    <div style="font-size:0.78rem;color:var(--muted2);margin-top:0.25rem;">Log how you feel. Patterns show up over time.</div>
  </div>
  <div class="note-card">
    <div class="note-hdr">
      <div class="note-date-lbl" id="note-date-lbl"></div>
      <div style="font-family:var(--mono);font-size:0.65rem;color:var(--muted)">today's note</div>
    </div>
    <textarea class="note-ta" id="note-ta" placeholder="How did today go? Energy, mood, what worked, what didn't..."></textarea>
    <br>
    <button class="note-save-btn" onclick="saveNote()">Save Note</button>
  </div>
  <div class="dash-section-title">Past Notes</div>
  <div class="past-notes" id="past-notes"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREDENTIALS
// To change password:
//   1. Open browser console (F12)
//   2. Run: crypto.subtle.digest('SHA-256', new TextEncoder().encode('yournewpassword'))
//            .then(b => console.log(Array.from(new Uint8Array(b)).map(x=>x.toString(16).padStart(2,'0')).join('')))
//   3. Copy the hash and replace AUTH_PASS_HASH below
// The actual password is NEVER stored in this file â€” safe to keep repo public
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AUTH_USER_HASH = '768a238e0667c41c9312d886dd3bf18df4825c6d73b0e096e33ac066a7207c05'; // "pawan"
const AUTH_PASS_HASH = '6305c53f64db3e012c057bbf9e4b78ba64500fc1feaefab7f7d0b31e461a42ae'; // "health2026"

async function hashStr(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HEALTH MODES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODES = [
  { id:'maintenance', label:'Maintenance', icon:'âš–ï¸', color:'#f0c040', desc:'Balanced daily routine' },
  { id:'cutting',     label:'Cutting',     icon:'ğŸ‹ï¸', color:'#3ecf82', desc:'Strict nutrition focus' },
  { id:'recovery',    label:'Recovery',    icon:'ğŸ˜´', color:'#9b6bda', desc:'Rest & gentle movement' },
  { id:'travel',      label:'Travel',      icon:'âœˆï¸', color:'#4d8ef5', desc:'Flexible, steps first' },
  { id:'highstress',  label:'High Stress', icon:'ğŸ§ ', color:'#f08040', desc:'Protect sleep & basics' },
];

// Focus decision engine per mode + context
function computeFocus(mode, weekData, todayStats) {
  const avg7 = weekAvg(weekData);
  const missedItems = getMostMissed(weekData, 1);
  const topMissed = missedItems[0];

  if (mode === 'recovery') return { icon:'ğŸ˜´', text:'Prioritise sleep tonight', why:'Recovery mode â€” rest is the goal today' };
  if (mode === 'travel')   return { icon:'ğŸš¶', text:'Hit 8,000 steps today', why:'Travel mode â€” movement over workout' };
  if (mode === 'highstress') return { icon:'ğŸ›¡ï¸', text:'Protect your sleep window', why:'High stress detected â€” sleep drives everything' };

  // Data-driven focus
  if (avg7 < 60) return { icon:'ğŸ”„', text:'Complete just 5 core tasks', why:`Momentum at ${avg7}% â€” rebuild gradually` };
  if (topMissed && topMissed.rate > 60) return { icon:'ğŸ¯', text: `Don't miss: ${topMissed.text}`, why:`Missed ${topMissed.rate}% of the last 7 days` };
  if (todayStats.pct === 0) return { icon:'ğŸŒ…', text:'Start with your morning shake', why:'First task unlocks momentum for the day' };
  if (todayStats.pct >= 80) return { icon:'ğŸ”¥', text:'You\'re crushing it â€” stay consistent', why:`${todayStats.pct}% complete today` };
  return { icon:'ğŸ’ª', text:'Hit 80% completion today', why:`Currently at ${todayStats.pct}% â€” the finish line is close` };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUTINE DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SECTIONS = [
  { icon:'ğŸŒ…', title:'Wake Up', time:'9:00 AM', cat:'morning', items:[
    {text:'Wake up'},
    {text:'1 glass warm water'},
    {text:'Light stretch', note:'2â€“3 min'},
  ]},
  { icon:'ğŸ¥¤', title:'Shake & Supplements', time:'9:15â€“9:35 AM', cat:'morning', items:[
    {text:'High-calorie shake', note:'Banana, whole milk, almonds + cashews, peanut butter, dates + jaggery, roasted chana powder, 1 scoop whey protein, creatine 5g'},
    {divider:true},
    {label:'Morning Supplements'},
    {text:'Multivitamin', note:'1 capsule'},
    {text:'Biotin 5000 mcg'},
  ]},
  { icon:'ğŸ³', title:'Breakfast', time:'11:45 AM', cat:'morning', items:[
    {text:'4 whole eggs OR paneer OR 2 rotis or bread'},
  ]},
  { icon:'ğŸš¿', title:'Shower & Grooming', time:'10:30â€“11:00 AM', cat:'midday', items:[
    {text:'Shampoo'},{text:'Face wash'},
    {divider:true},{label:'Skincare'},
    {text:'AXIS-Y Dark Spot Serum'},
    {text:'COSRX Oil-Free Moisturizer'},
    {text:'Sunscreen SPF 50', note:'Mandatory'},
    {divider:true},{label:'Hair & Beard'},
    {text:'Rogaine 5% Minoxidil', note:'On scalp'},
    {text:'Beard oil', note:'Bossman â€“ Naked'},
  ]},
  { icon:'ğŸ½ï¸', title:'Lunch', time:'2:00â€“3:00 PM', cat:'midday', items:[
    {text:'Chicken / Fish / Prawns / Goat & Rice / Dal / Veggies / 1 tsp ghee'},
    {divider:true},{label:'After Food Supplements'},
    {text:'Vitamin D3 + K2'},
    {text:'Zinc 22mg', note:'Always after food'},
  ]},
  { icon:'â˜•', title:'Light Snack', time:'5:30 PM', cat:'midday', items:[
    {text:'Banana + peanuts OR 2 boiled eggs OR Curd + fruit'},
  ]},
  { icon:'ğŸŒ™', title:'Dinner', time:'9:45 PM', cat:'night', items:[
    {text:'Chicken / Fish / 3 eggs & Roti or rice & Veggies'},
  ]},
  { icon:'ğŸ¥›', title:'Night Protein', time:'10:30 PM', cat:'night', items:[{text:'Greek yogurt'}]},
  { icon:'ğŸ’Š', title:'Night Supplement', time:'11:30 PM', cat:'night', items:[{text:'Magnesium glycinate 200â€“300mg'}]},
  { icon:'ğŸ˜´', title:'Sleep', time:'12:00â€“1:00 AM', cat:'night', items:[{text:'Sleep'}]},
];

const CAT_COLORS = { morning:'#f0c040', midday:'#4d8ef5', night:'#9b6bda' };
const CAT_LABELS  = { morning:'ğŸŒ… Morning', midday:'â˜€ï¸ Midday', night:'ğŸŒ™ Night' };
const HEAT_COLORS = ['#141a24','#1e3020','#2a5030','rgba(62,207,130,0.5)','#3ecf82'];

// Missed items fix suggestions
const FIXES = {
  'High-calorie shake': 'Prep ingredients the night before',
  'Greek yogurt': 'Swap with protein shake if unavailable',
  'Sunscreen SPF 50': 'Leave it next to toothbrush',
  'Rogaine 5% Minoxidil': 'Set a phone alarm for this',
  'Magnesium glycinate 200â€“300mg': 'Keep bottle on bedside table',
  'Sleep': 'Set a hard 12am phone alarm',
  'Vitamin D3 + K2': 'Pair with lunch â€” leave on dining table',
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function isLoggedIn() { return sessionStorage.getItem('hos_auth') === '1'; }

async function doLogin() {
  const u = document.getElementById('li-user').value.trim();
  const p = document.getElementById('li-pass').value;
  const err = document.getElementById('login-err');
  const btn = document.getElementById('login-btn');

  const [uHash, pHash] = await Promise.all([hashStr(u), hashStr(p)]);

  if (uHash === AUTH_USER_HASH && pHash === AUTH_PASS_HASH) {
    sessionStorage.setItem('hos_auth','1');
    document.getElementById('login-screen').classList.add('hidden');
    err.classList.remove('show');
    bootApp();
  } else {
    err.classList.add('show');
    btn.classList.remove('shake'); void btn.offsetWidth; btn.classList.add('shake');
    document.getElementById('li-pass').value = '';
    document.getElementById('li-pass').focus();
  }
}
function doLogout() { sessionStorage.removeItem('hos_auth'); location.reload(); }

document.getElementById('li-user').addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('li-pass').focus(); });
document.getElementById('li-pass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getConfig() { return { user:'pawanyandapalli7', repo:'health-tracker', token: localStorage.getItem('gh_token')||'' }; }
function isConfigured() { return !!localStorage.getItem('gh_token'); }

function saveConfig() {
  const token = document.getElementById('cfg-token').value.trim();
  const err = document.getElementById('modal-err');
  const btn = document.getElementById('cfg-save-btn');
  err.style.display = 'none';
  if (!token) { err.textContent = 'Token required.'; err.style.display='block'; return; }
  btn.disabled = true; btn.textContent = 'Connecting...';
  const {user,repo} = getConfig();
  fetch(`https://api.github.com/repos/${user}/${repo}`, { headers:{ Authorization:`token ${token}`, Accept:'application/vnd.github.v3+json' } })
    .then(r => { if(!r.ok) throw new Error(`${r.status}`); localStorage.setItem('gh_token',token); document.getElementById('setup-overlay').classList.add('hidden'); initApp(); })
    .catch(e => { err.textContent='âœ— '+e.message; err.style.display='block'; btn.disabled=false; btn.textContent='Connect & Save'; });
}
function openSettings() { document.getElementById('cfg-token').value=getConfig().token; document.getElementById('setup-overlay').classList.remove('hidden'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GITHUB STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA_FILE = 'data.json';
let ghSha = null;

async function ghGet() {
  const {user,repo,token} = getConfig();
  setSyncStatus('syncing','loading...');
  try {
    const r = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${DATA_FILE}`, { headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json'} });
    if (r.status===404) { ghSha=null; setSyncStatus('synced','connected'); return {}; }
    if (!r.ok) throw new Error(r.status);
    const j = await r.json();
    ghSha = j.sha;
    const data = JSON.parse(atob(j.content.replace(/\n/g,'')));
    setSyncStatus('synced','synced'); return data;
  } catch(e) { setSyncStatus('error','sync error'); return null; }
}

async function ghSave(data) {
  const {user,repo,token} = getConfig();
  setSaveDot('syncing'); document.getElementById('save-lbl').textContent='saving...';
  try {
    const body = { message:`health: ${activeKey}`, content: btoa(unescape(encodeURIComponent(JSON.stringify(data,null,2)))) };
    if (ghSha) body.sha = ghSha;
    const r = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/${DATA_FILE}`, { method:'PUT', headers:{Authorization:`token ${token}`,Accept:'application/vnd.github.v3+json','Content-Type':'application/json'}, body:JSON.stringify(body) });
    if (!r.ok) throw new Error(r.status);
    const j = await r.json(); ghSha = j.content.sha;
    setSaveDot('synced'); document.getElementById('save-lbl').textContent='saved âœ“';
    setTimeout(()=>{ setSaveDot(''); document.getElementById('save-lbl').textContent='ready'; }, 2000);
  } catch(e) { setSaveDot('error'); document.getElementById('save-lbl').textContent='save failed'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let localData = {};
let activeKey = todayKey();
let saveTimer = null;

function todayKey() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function localDateKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}
function isToday() { return activeKey === todayKey(); }
function getActiveData() { return localData[activeKey] || { checks:{}, note:'', mood:0, energy:0, graceUsed:[] }; }
function setActiveData(d) { localData[activeKey]=d; scheduleSave(); }
function scheduleSave() { clearTimeout(saveTimer); saveTimer=setTimeout(()=>ghSave(localData),1200); }

function getCurrentMode() { return localStorage.getItem('health_mode') || 'maintenance'; }
function setCurrentMode(m) { localStorage.setItem('health_mode',m); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE PICKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initDatePicker() {
  const p = document.getElementById('date-picker');
  p.value = activeKey; p.max = todayKey();
  document.getElementById('next-btn').disabled = isToday();
  document.getElementById('today-badge').style.display = isToday() ? 'inline' : 'none';
}
function onDateChange(v) { if(!v) return; activeKey=v; initDatePicker(); renderToday(); }
function shiftDay(d) {
  const dt = new Date(activeKey+'T12:00:00'); dt.setDate(dt.getDate()+d);
  const nk = localDateKey(dt);
  if(nk > todayKey()) return;
  activeKey=nk; document.getElementById('date-picker').value=nk; initDatePicker(); renderToday();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAllCheckable() {
  const items=[];
  SECTIONS.forEach((s,si)=>s.items.forEach((it,ii)=>{ if(it.text) items.push({si,ii,text:it.text,cat:s.cat,section:s.title}); }));
  return items;
}

function calcStats(dayData) {
  const all=getAllCheckable();
  const done=all.filter(i=>dayData.checks&&dayData.checks[`${i.si}-${i.ii}`]).length;
  return {total:all.length, done, pct: all.length ? Math.round(done/all.length*100) : 0};
}

function calcMomentum(days7) {
  // avg + consistency bonus - volatility penalty
  if(!days7.length) return 0;
  const avgs = days7.map(k=>localData[k]?calcStats(localData[k]).pct:0);
  const avg = avgs.reduce((a,b)=>a+b,0)/avgs.length;
  const consistency = avgs.filter(v=>v>=70).length/avgs.length * 10;
  const variance = Math.sqrt(avgs.reduce((a,v)=>a+Math.pow(v-avg,2),0)/avgs.length);
  const volatility = Math.min(variance/10, 8);
  return Math.round(Math.min(100, Math.max(0, avg + consistency - volatility)));
}

function weekAvg(days7) {
  if(!days7.length) return 0;
  return Math.round(days7.reduce((a,k)=>a+(localData[k]?calcStats(localData[k]).pct:0),0)/days7.length);
}

function getLast7Keys() {
  const keys=[];
  for(let i=6;i>=0;i--) { const d=new Date(); d.setDate(d.getDate()-i); keys.push(localDateKey(d)); }
  return keys;
}

function getLast14Keys(offset=0) {
  const keys=[];
  for(let i=13+offset;i>=offset;i--) { const d=new Date(); d.setDate(d.getDate()-i); keys.push(localDateKey(d)); }
  return keys;
}

function calcStreak() {
  let s=0; const t=new Date();
  for(let i=0;i<365;i++) {
    const d=new Date(t); d.setDate(d.getDate()-i);
    const k=localDateKey(d);
    const day=localData[k];
    if(!day){if(i===0)continue; break;}
    // grace token counts
    const grace=(day.graceUsed||[]).length>0;
    if(calcStats(day).pct>=80||grace) s++;
    else if(i>0) break;
  }
  return s;
}

function getMostMissed(days7, limit=6) {
  const all=getAllCheckable();
  if(!days7.length) return [];
  return all.map(item=>{
    let missed=0;
    days7.forEach(k=>{ if(localData[k]&&!(localData[k].checks&&localData[k].checks[`${item.si}-${item.ii}`])) missed++; });
    return {...item, rate: Math.round(missed/days7.length*100)};
  }).sort((a,b)=>b.rate-a.rate).slice(0,limit);
}

function getTrend(curr, prev) {
  const diff = curr - prev;
  if(diff > 5) return {arrow:'â†‘', cls:'up'};
  if(diff < -5) return {arrow:'â†“', cls:'down'};
  return {arrow:'â†’', cls:'flat'};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODES UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderModeMenu() {
  const menu = document.getElementById('mode-menu');
  const cur = getCurrentMode();
  menu.innerHTML = MODES.map(m=>`
    <div class="mode-item ${m.id===cur?'active':''}" onclick="selectMode('${m.id}')">
      <span>${m.icon}</span>
      <div><div class="mode-item-name">${m.label}</div><div class="mode-item-desc">${m.desc}</div></div>
    </div>`).join('');
}

function toggleModeMenu() {
  renderModeMenu();
  document.getElementById('mode-menu').classList.toggle('open');
}

function selectMode(id) {
  setCurrentMode(id);
  document.getElementById('mode-menu').classList.remove('open');
  updateModeBadge();
  renderFocus();
}

function updateModeBadge() {
  const m = MODES.find(x=>x.id===getCurrentMode())||MODES[0];
  document.getElementById('mode-label').textContent = m.icon+' '+m.label;
  document.getElementById('mode-dot').style.background = m.color;
}

// Close mode menu on outside click
document.addEventListener('click', e => {
  if(!document.getElementById('mode-selector').contains(e.target))
    document.getElementById('mode-menu').classList.remove('open');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GRACE TOKENS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAX_GRACE = 2;

function renderGraceTokens() {
  const d = getActiveData();
  const used = (d.graceUsed||[]).length;
  for(let i=0;i<MAX_GRACE;i++) {
    const el=document.getElementById(`gt${i}`);
    if(!el) continue;
    el.className='grace-token'+(i<used?' used':' available');
    el.title=i<used?`Grace token ${i+1} used`:`Use grace token ${i+1} (skip counts as complete)`;
  }
}

function useGrace(idx) {
  const d=getActiveData();
  if(!d.graceUsed) d.graceUsed=[];
  if(d.graceUsed.includes(idx)) {
    d.graceUsed=d.graceUsed.filter(x=>x!==idx);
  } else {
    if(d.graceUsed.length>=MAX_GRACE) return;
    d.graceUsed.push(idx);
  }
  setActiveData(d);
  renderGraceTokens();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COPY YESTERDAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyYesterday() {
  const prev = new Date(activeKey+'T12:00:00');
  prev.setDate(prev.getDate()-1);
  const prevKey = localDateKey(prev);
  const prevData = localData[prevKey];
  if(!prevData||!prevData.checks||Object.keys(prevData.checks).length===0) {
    alert('No data found for yesterday.'); return;
  }
  if(!confirm('Copy yesterday\'s completed tasks to today?')) return;
  const d=getActiveData();
  d.checks={...prevData.checks};
  setActiveData(d);
  renderToday();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FOCUS ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFocus() {
  const days7=getLast7Keys();
  const todayStats=calcStats(getActiveData());
  const f=computeFocus(getCurrentMode(),days7,todayStats);
  document.getElementById('focus-icon').textContent=f.icon;
  document.getElementById('focus-text').textContent=f.text;
  document.getElementById('focus-why').textContent=f.why;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOMENTUM CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMomentum() {
  const days7=getLast7Keys();
  const score=calcMomentum(days7);
  const el=document.getElementById('m-score');
  const st=document.getElementById('m-status');
  const bar=document.getElementById('m-bar');
  el.textContent=score;
  el.className='momentum-score '+(score>=80?'thriving':score>=60?'stable':'risk');
  const statusText=score>=80?'ğŸ”¥ Thriving':score>=60?'ğŸŸ¡ Stable':'ğŸ”´ At Risk';
  st.textContent=statusText;
  st.className='momentum-status '+(score>=80?'thriving':score>=60?'stable':'risk');
  bar.style.width=score+'%';
  bar.style.background=score>=80?'var(--green)':score>=60?'var(--gold)':'var(--red)';

  // streak
  const streak=calcStreak();
  document.getElementById('st-streak').textContent=streak;

  // 7-day avg vs prior 7
  const avg7=weekAvg(days7);
  const prior7=getLast14Keys(7);
  const avgPrior=weekAvg(prior7);
  const t7=getTrend(avg7,avgPrior);
  document.getElementById('st-avg').textContent=avg7+'%';
  document.getElementById('st-avg-trend').textContent=t7.arrow;
  document.getElementById('st-avg-trend').className='trend '+t7.cls;

  // today
  const todayStats=calcStats(getActiveData());
  document.getElementById('st-today').textContent=todayStats.pct+'%';
  document.getElementById('st-today-sub').textContent=`${todayStats.done} / ${todayStats.total} tasks`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOOD / ENERGY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MOOD_COLORS=['#f04f4f','#f08040','#f0c040','#4d8ef5','#3ecf82'];
const MOOD_EMOJIS=['ğŸ˜','ğŸ˜•','ğŸ˜','ğŸ™‚','ğŸ˜„'];
const MOOD_LABELS=['Terrible','Bad','Neutral','Good','Amazing'];
const ENERGY_EMOJIS=['ğŸª«','ğŸ˜´','âš¡','ğŸ’ª','ğŸš€'];
const ENERGY_LABELS=['Drained','Low','Okay','High','Unstoppable'];

function renderRatingDots(containerId, field, emojis, colors, labels) {
  const el=document.getElementById(containerId);
  const d=getActiveData();
  const val=d[field]||0;
  el.innerHTML='';
  for(let i=1;i<=5;i++) {
    const dot=document.createElement('div');
    dot.className='rdot'+(val===i?' sel':'');
    dot.textContent=emojis[i-1];
    dot.title=`${i} â€” ${labels[i-1]}`;
    dot.dataset.label=labels[i-1];
    if(val===i) dot.style.background=colors[i-1];
    dot.addEventListener('click',()=>{
      const day=getActiveData();
      day[field]=val===i?0:i;
      setActiveData(day);
      renderRatingDots(containerId,field,emojis,colors,labels);
    });
    el.appendChild(dot);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHECKLIST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderSections() {
  const dayData=getActiveData();
  const container=document.getElementById('sections-container');
  container.innerHTML='';

  SECTIONS.forEach((section,si)=>{
    const checkable=section.items.filter(i=>i.text);
    const done=checkable.filter(item=>{ const ii=section.items.indexOf(item); return dayData.checks&&dayData.checks[`${si}-${ii}`]; }).length;
    const pct=checkable.length?Math.round(done/checkable.length*100):0;
    const complete=done===checkable.length&&checkable.length>0;

    const sEl=document.createElement('div');
    sEl.className='section'+(complete?' complete':'');

    const hdr=document.createElement('div');
    hdr.className='sec-hdr';
    hdr.innerHTML=`
      <div class="sec-ico">${section.icon}</div>
      <div class="sec-meta"><div class="sec-name">${section.title}</div><div class="sec-time">${section.time}</div></div>
      <div class="sec-prog">
        <div class="sec-bw"><div class="sec-bf" id="sbf-${si}" style="width:${pct}%;background:${CAT_COLORS[section.cat]}"></div></div>
        <div class="sec-cnt" id="sbc-${si}">${checkable.length?`${done}/${checkable.length}`:''}</div>
      </div>
      <div class="chev">â–¾</div>`;
    hdr.addEventListener('click',()=>sEl.classList.toggle('collapsed'));

    const body=document.createElement('div');
    body.className='sec-body';

    section.items.forEach((item,ii)=>{
      if(item.label){ const l=document.createElement('div'); l.className='sublbl'; l.textContent=item.label; body.appendChild(l); return; }
      if(item.divider){ const d=document.createElement('hr'); d.className='hdivider'; body.appendChild(d); return; }
      const key=`${si}-${ii}`;
      const checked=!!(dayData.checks&&dayData.checks[key]);
      const div=document.createElement('div');
      div.className='item'+(checked?' checked':'');
      div.innerHTML=`<div class="cb"><svg viewBox="0 0 12 9"><polyline points="1,4.5 4.5,8 11,1"/></svg></div><div><div class="item-txt">${item.text}</div>${item.note?`<div class="item-note">${item.note}</div>`:''}</div>`;
      div.addEventListener('click',()=>{
        const d=getActiveData();
        if(!d.checks) d.checks={};
        d.checks[key]=!d.checks[key];
        setActiveData(d);
        div.classList.toggle('checked',!!d.checks[key]);
        updateSecBar(si,section);
        renderMomentum(); renderFocus();
        checkConfetti();
      });
      body.appendChild(div);
    });

    sEl.appendChild(hdr); sEl.appendChild(body);
    container.appendChild(sEl);
  });
}

function updateSecBar(si, section) {
  const d=getActiveData();
  const checkable=section.items.filter(i=>i.text);
  const done=checkable.filter(item=>{ const ii=section.items.indexOf(item); return d.checks&&d.checks[`${si}-${ii}`]; }).length;
  const pct=checkable.length?Math.round(done/checkable.length*100):0;
  const bf=document.getElementById(`sbf-${si}`); const bc=document.getElementById(`sbc-${si}`);
  if(bf) bf.style.width=pct+'%';
  if(bc) bc.textContent=`${done}/${checkable.length}`;
}

function resetDay() {
  const lbl=isToday()?'today':new Date(activeKey+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'});
  if(!confirm(`Reset all tasks for ${lbl}?`)) return;
  const d=getActiveData(); d.checks={}; setActiveData(d); renderToday();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER TODAY (master)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderToday() {
  initDatePicker();
  updateModeBadge();
  renderFocus();
  renderMomentum();
  renderRatingDots('mood-dots','mood',MOOD_EMOJIS,MOOD_COLORS,MOOD_LABELS);
  renderRatingDots('energy-dots','energy',ENERGY_EMOJIS,MOOD_COLORS,ENERGY_LABELS);
  renderSections();
  renderGraceTokens();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard() {
  const allKeys=Object.keys(localData).sort();
  const allItems=getAllCheckable();
  const days7=getLast7Keys();
  const score=calcMomentum(days7);

  // Weekly summary
  const wrapEl=document.getElementById('weekly-summary-wrap');
  if(allKeys.length===0) { wrapEl.innerHTML=''; }
  else {
    const avg7=weekAvg(days7);
    const prior7=getLast14Keys(7);
    const avgPrior=weekAvg(prior7);
    const trend=getTrend(avg7,avgPrior);
    const strongCat=getBestCat(days7);
    const weakCat=getWorstCat(days7);
    const f=computeFocus(getCurrentMode(),days7,calcStats(getActiveData()));

    wrapEl.innerHTML=`
      <div class="weekly-summary">
        <div class="ws-title">ğŸ“Š Weekly Intelligence</div>
        <div class="ws-body">
          <strong>This week</strong> you averaged <strong>${avg7}%</strong> completion
          (${trend.arrow} ${Math.abs(avg7-avgPrior)}% vs last week).<br>
          Strongest area: <strong>${CAT_LABELS[strongCat]||'â€”'}</strong> &nbsp;Â·&nbsp;
          Needs work: <strong>${CAT_LABELS[weakCat]||'â€”'}</strong><br>
          Momentum score: <strong style="color:${score>=80?'var(--green)':score>=60?'var(--gold)':'var(--red)'}">${score} â€” ${score>=80?'Thriving':score>=60?'Stable':'At Risk'}</strong>
        </div>
        <div class="ws-focus">
          <div class="ws-focus-label">Next Focus</div>
          <div class="ws-focus-text">${f.icon} ${f.text}</div>
        </div>
      </div>`;
  }

  // 30-day momentum chart
  const chartEl=document.getElementById('momentum-chart');
  chartEl.innerHTML='';
  for(let i=29;i>=0;i--) {
    const d=new Date(); d.setDate(d.getDate()-i);
    const k=localDateKey(d);
    const day=localData[k];
    const pct=day?calcStats(day).pct:null;
    const lbl=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const color=pct===null?'var(--border2)':pct>=80?'var(--green)':pct>=60?'var(--gold)':'var(--red)';
    const col=document.createElement('div'); col.className='bcol';
    col.innerHTML=`<div class="bbar" style="height:${pct??0}%;background:${color}" data-tip="${lbl}: ${pct!==null?pct+'%':'no data'}"></div>${(29-i)%7===0?`<div class="blbl">${lbl}</div>`:'<div class="blbl"></div>'}`;
    chartEl.appendChild(col);
  }

  // Category breakdown
  const catEl=document.getElementById('cat-breakdown');
  if(!allKeys.length) { catEl.innerHTML='<div class="empty-state">No data yet.</div>'; }
  else {
    catEl.innerHTML='';
    ['morning','midday','night'].forEach(cat=>{
      const catItems=allItems.filter(i=>i.cat===cat);
      const total=catItems.length*allKeys.length;
      let done=0;
      allKeys.forEach(k=>catItems.forEach(i=>{ if(localData[k]&&localData[k].checks&&localData[k].checks[`${i.si}-${i.ii}`]) done++; }));
      const pct=total?Math.round(done/total*100):0;
      const trend7=getCatTrend(cat);
      const div=document.createElement('div'); div.className='cat-row';
      div.innerHTML=`<div class="cat-name" style="color:${CAT_COLORS[cat]}">${CAT_LABELS[cat]}</div><div class="cat-bw"><div class="cat-bf" style="width:${pct}%;background:${CAT_COLORS[cat]}"></div></div><span class="trend ${trend7.cls}" style="font-size:0.8rem">${trend7.arrow}</span><div class="cat-pct">${pct}%</div>`;
      catEl.appendChild(div);
    });
  }

  // Mood & energy charts
  renderMoodEnergyChart('mood-chart','mood','#4d8ef5');
  renderMoodEnergyChart('energy-chart','energy','#3ecf82');

  // Missed items with fixes
  const missEl=document.getElementById('missed-list');
  if(!allKeys.length) { missEl.innerHTML='<div class="empty-state">No data yet.</div>'; }
  else {
    missEl.innerHTML='';
    const missed=getMostMissed(days7,6);
    missed.forEach(item=>{
      const fix=FIXES[item.text];
      const div=document.createElement('div'); div.className='missed-row';
      div.innerHTML=`<div class="missed-name">${item.text}</div><div class="missed-bw"><div class="missed-bf" style="width:${item.rate}%"></div></div><div class="missed-pct">${item.rate}%</div>${fix?`<div class="missed-fix" title="${fix}">ğŸ”§</div>`:''}`;
      if(fix) div.title=`ğŸ’¡ Fix: ${fix}`;
      missEl.appendChild(div);
    });
  }

  // Trend signals
  const trendEl=document.getElementById('trend-signals');
  trendEl.innerHTML='';
  const signals=computeTrendSignals(days7);
  if(!signals.length) { trendEl.innerHTML='<div class="empty-state">Track more days to see signals.</div>'; }
  else signals.forEach(s=>{
    const div=document.createElement('div');
    div.style.cssText='display:flex;align-items:center;gap:0.7rem;padding:0.5rem 0.75rem;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:0.45rem;font-size:0.8rem;';
    div.innerHTML=`<span style="font-size:1rem">${s.icon}</span><span>${s.text}</span>`;
    trendEl.appendChild(div);
  });

  // Heatmap
  const heatEl=document.getElementById('heatmap');
  heatEl.innerHTML='';
  for(let i=29;i>=0;i--) {
    const d=new Date(); d.setDate(d.getDate()-i);
    const k=localDateKey(d);
    const day=localData[k];
    const pct=day?calcStats(day).pct:null;
    let ci=0;
    if(pct!==null) ci=pct>=90?4:pct>=70?3:pct>=50?2:pct>0?1:0;
    const cell=document.createElement('div'); cell.className='hcell';
    cell.style.background=HEAT_COLORS[ci];
    cell.dataset.tip=`${d.toLocaleDateString('en-US',{month:'short',day:'numeric'})}: ${pct!==null?pct+'%':'no data'}`;
    heatEl.appendChild(cell);
  }
}

function renderMoodEnergyChart(id, field, color) {
  const el=document.getElementById(id); el.innerHTML='';
  for(let i=6;i>=0;i--) {
    const d=new Date(); d.setDate(d.getDate()-i);
    const k=localDateKey(d);
    const val=localData[k]?localData[k][field]||0:0;
    const lbl=d.toLocaleDateString('en-US',{weekday:'short'});
    const col=document.createElement('div'); col.className='mood-col';
    col.innerHTML=`<div class="mood-bar" style="height:${val*20}%;background:${color};opacity:${val?0.8:0.15}"></div><div class="mood-blbl">${lbl}</div>`;
    el.appendChild(col);
  }
}

function getBestCat(days7) {
  const allItems=getAllCheckable();
  const cats=['morning','midday','night'];
  const pcts=cats.map(cat=>{
    const items=allItems.filter(i=>i.cat===cat);
    let done=0,total=0;
    days7.forEach(k=>{ if(localData[k]) { items.forEach(i=>{ if(localData[k].checks&&localData[k].checks[`${i.si}-${i.ii}`]) done++; total++; }); } });
    return total?done/total:0;
  });
  return cats[pcts.indexOf(Math.max(...pcts))];
}

function getWorstCat(days7) {
  const allItems=getAllCheckable();
  const cats=['morning','midday','night'];
  const pcts=cats.map(cat=>{
    const items=allItems.filter(i=>i.cat===cat);
    let done=0,total=0;
    days7.forEach(k=>{ if(localData[k]) { items.forEach(i=>{ if(localData[k].checks&&localData[k].checks[`${i.si}-${i.ii}`]) done++; total++; }); } });
    return total?done/total:1;
  });
  return cats[pcts.indexOf(Math.min(...pcts))];
}

function getCatTrend(cat) {
  const allItems=getAllCheckable().filter(i=>i.cat===cat);
  const days7=getLast7Keys(); const prior7=getLast14Keys(7);
  const calc=days=>{ let d=0,t=0; days.forEach(k=>{ if(localData[k]) allItems.forEach(i=>{ if(localData[k].checks&&localData[k].checks[`${i.si}-${i.ii}`]) d++; t++; }); }); return t?d/t:0; };
  return getTrend(calc(days7)*100, calc(prior7)*100);
}

function computeTrendSignals(days7) {
  const signals=[];
  const avg7=weekAvg(days7);
  const prior7=getLast14Keys(7);
  const avgPrior=weekAvg(prior7);
  if(avg7>avgPrior+10) signals.push({icon:'ğŸ“ˆ',text:`Completion up ${avg7-avgPrior}% vs last week`});
  if(avg7<avgPrior-10) signals.push({icon:'ğŸ“‰',text:`Completion down ${avgPrior-avg7}% vs last week`});
  const streak=calcStreak();
  if(streak>=7) signals.push({icon:'ğŸ”¥',text:`${streak}-day streak â€” exceptional consistency`});
  if(streak===0) signals.push({icon:'âš ï¸',text:'No active streak â€” start fresh today'});
  // mood trend
  const recentMoods=days7.map(k=>localData[k]?localData[k].mood||0:0).filter(v=>v>0);
  if(recentMoods.length>=3) {
    const avgMood=recentMoods.reduce((a,b)=>a+b,0)/recentMoods.length;
    if(avgMood>=4) signals.push({icon:'ğŸ˜„',text:`Strong mood week â€” avg ${avgMood.toFixed(1)}/5`});
    if(avgMood<=2) signals.push({icon:'ğŸ˜',text:`Low mood detected â€” consider recovery mode`});
  }
  // night category
  const nightItems=getAllCheckable().filter(i=>i.cat==='night');
  const nightAvg=days7.reduce((acc,k)=>{
    if(!localData[k]) return acc;
    const done=nightItems.filter(i=>localData[k].checks&&localData[k].checks[`${i.si}-${i.ii}`]).length;
    return acc+(done/nightItems.length);
  },0)/Math.max(days7.filter(k=>localData[k]).length,1)*100;
  if(nightAvg<50) signals.push({icon:'ğŸŒ™',text:`Night routine only ${Math.round(nightAvg)}% â€” focus here`});
  if(!signals.length) signals.push({icon:'âœ…',text:'All trends looking healthy'});
  return signals.slice(0,5);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderNotes() {
  const d=new Date(activeKey+'T12:00:00');
  document.getElementById('note-date-lbl').textContent=d.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
  document.getElementById('note-ta').value=getActiveData().note||'';
  const el=document.getElementById('past-notes'); el.innerHTML='';
  const keys=Object.keys(localData).sort().reverse().filter(k=>localData[k].note&&localData[k].note.trim());
  if(!keys.length){ el.innerHTML='<div class="empty-state">No notes yet.</div>'; return; }
  keys.forEach(k=>{
    const dt=new Date(k+'T12:00:00');
    const d=document.createElement('div'); d.className='past-note';
    d.innerHTML=`<div class="pn-date">${dt.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'})}</div><div class="pn-text">${localData[k].note}</div>`;
    el.appendChild(d);
  });
}
function saveNote() {
  const d=getActiveData(); d.note=document.getElementById('note-ta').value; setActiveData(d); renderNotes();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV + SYNC UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchView(view, btn) {
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(`view-${view}`).classList.add('active');
  if(btn) btn.classList.add('active');
  if(view==='dashboard') renderDashboard();
  if(view==='notes') renderNotes();
  if(view==='weight') renderWeight();
  if(view==='records') renderRecords();
}

function setSyncStatus(state, lbl) {
  const dot=document.getElementById('sdot'); const el=document.getElementById('slbl');
  dot.className='sdot'+(state?' '+state:'');
  el.textContent=lbl;
  el.style.color=state==='synced'?'var(--green)':state==='error'?'var(--red)':'var(--muted2)';
}

function setSaveDot(state) {
  const el=document.getElementById('save-dot');
  if(el) el.className='sdot'+(state?' '+state:'');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let confettiActive = false;
function fireConfetti() {
  if (confettiActive) return;
  confettiActive = true;
  const canvas = document.getElementById('confetti-canvas');
  canvas.style.display = 'block';
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const ctx = canvas.getContext('2d');
  const pieces = Array.from({length: 120}, () => ({
    x: Math.random() * canvas.width,
    y: -10 - Math.random() * 100,
    r: 4 + Math.random() * 6,
    d: 2 + Math.random() * 3,
    color: ['#f0c040','#3ecf82','#4d8ef5','#f08040','#9b6bda','#fff'][Math.floor(Math.random()*6)],
    tilt: Math.random() * 10 - 5,
    tiltAngle: 0,
    tiltSpeed: 0.1 + Math.random() * 0.2,
  }));
  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    pieces.forEach(p => {
      p.tiltAngle += p.tiltSpeed;
      p.y += p.d;
      p.x += Math.sin(p.tiltAngle) * 1.5;
      p.tilt = Math.sin(p.tiltAngle) * 12;
      ctx.beginPath();
      ctx.lineWidth = p.r / 2;
      ctx.strokeStyle = p.color;
      ctx.moveTo(p.x + p.tilt + p.r / 4, p.y);
      ctx.lineTo(p.x + p.tilt, p.y + p.tilt + p.r / 4);
      ctx.stroke();
    });
    frame++;
    if (frame < 180) requestAnimationFrame(draw);
    else { ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display='none'; confettiActive=false; }
  }
  draw();
}

let lastCompletionPct = -1;
function checkConfetti() {
  const stats = calcStats(getActiveData());
  if (stats.pct === 100 && lastCompletionPct < 100) fireConfetti();
  lastCompletionPct = stats.pct;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA â€” SERVICE WORKER + INSTALL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let deferredInstallPrompt = null;

window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredInstallPrompt = e;
  document.getElementById('install-banner').classList.add('show');
});

function triggerInstall() {
  if (!deferredInstallPrompt) return;
  deferredInstallPrompt.prompt();
  deferredInstallPrompt.userChoice.then(() => {
    deferredInstallPrompt = null;
    document.getElementById('install-banner').classList.remove('show');
  });
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEIGHT TRACKER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getWeightData() {
  try { return JSON.parse(localStorage.getItem('hos_weight') || '{}'); } catch { return {}; }
}
function saveWeightData(d) { localStorage.setItem('hos_weight', JSON.stringify(d)); }

function logWeight() {
  const val = parseFloat(document.getElementById('w-input').value);
  const date = document.getElementById('w-date').value || todayKey();
  if (!val || val < 20 || val > 300) { alert('Please enter a valid weight (20â€“300 kg)'); return; }
  const d = getWeightData();
  d[date] = val;
  saveWeightData(d);
  document.getElementById('w-input').value = '';
  renderWeight();
}

function deleteWeight(date) {
  const d = getWeightData();
  delete d[date];
  saveWeightData(d);
  renderWeight();
}

function renderWeight() {
  const raw = getWeightData();
  const sorted = Object.keys(raw).sort();
  const last30 = sorted.slice(-30);

  // Stats
  const statsEl = document.getElementById('weight-stats');
  if (!sorted.length) {
    statsEl.innerHTML = '<div class="empty-state" style="grid-column:1/-1">No weight logged yet. Add your first entry above.</div>';
    document.getElementById('weight-svg').innerHTML = '';
    document.getElementById('weight-log').innerHTML = '';
    return;
  }

  const vals = last30.map(k => raw[k]);
  const latest = vals[vals.length - 1];
  const oldest = vals[0];
  const change = latest - oldest;
  const min = Math.min(...vals);
  const max = Math.max(...vals);
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;

  statsEl.innerHTML = `
    <div class="w-stat"><div class="w-stat-label">Current</div><div class="w-stat-value" style="color:var(--gold)">${latest.toFixed(1)}<span style="font-size:0.8rem;font-weight:400"> kg</span></div><div class="w-stat-sub">as of ${new Date(last30[last30.length-1]+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}</div></div>
    <div class="w-stat"><div class="w-stat-label">Change</div><div class="w-stat-value" style="color:${change<=0?'var(--green)':'var(--red)'}">${change>0?'+':''}${change.toFixed(1)}<span style="font-size:0.8rem;font-weight:400"> kg</span></div><div class="w-stat-sub">over ${last30.length} days</div></div>
    <div class="w-stat"><div class="w-stat-label">Min / Max</div><div class="w-stat-value" style="color:var(--blue);font-size:1.1rem">${min.toFixed(1)} / ${max.toFixed(1)}</div><div class="w-stat-sub">kg range</div></div>
    <div class="w-stat"><div class="w-stat-label">Avg</div><div class="w-stat-value" style="color:var(--muted2)">${avg.toFixed(1)}<span style="font-size:0.8rem;font-weight:400"> kg</span></div><div class="w-stat-sub">30-day average</div></div>`;

  // SVG Line Chart
  const svg = document.getElementById('weight-svg');
  const W = 600, H = 140, pad = 20;
  const range = max - min || 1;
  const pts = last30.map((k,i) => {
    const x = pad + (i/(last30.length-1||1)) * (W - pad*2);
    const y = H - pad - ((raw[k]-min)/range) * (H - pad*2);
    return {x,y,k,v:raw[k]};
  });

  // Grid lines
  let gridLines = '';
  for (let i=0;i<=4;i++) {
    const y = pad + (i/4)*(H-pad*2);
    const val = max - (i/4)*range;
    gridLines += `<line x1="${pad}" y1="${y}" x2="${W-pad}" y2="${y}" stroke="#1c2233" stroke-width="1"/>
      <text x="${pad-5}" y="${y+4}" fill="#4a5470" font-size="9" text-anchor="end">${val.toFixed(1)}</text>`;
  }

  const pathD = pts.map((p,i)=>`${i===0?'M':'L'}${p.x},${p.y}`).join(' ');
  const areaD = pathD + ` L${pts[pts.length-1].x},${H-pad} L${pts[0].x},${H-pad} Z`;

  const dots = pts.map(p => `<circle cx="${p.x}" cy="${p.y}" r="3" fill="var(--gold)" stroke="var(--bg)" stroke-width="1.5">
    <title>${new Date(p.k+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'})}: ${p.v} kg</title></circle>`).join('');

  svg.innerHTML = `
    <defs><linearGradient id="wg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#f0c040" stop-opacity="0.25"/><stop offset="100%" stop-color="#f0c040" stop-opacity="0"/></linearGradient></defs>
    ${gridLines}
    <path d="${areaD}" fill="url(#wg)"/>
    <path d="${pathD}" fill="none" stroke="#f0c040" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    ${dots}`;

  // Log list
  const logEl = document.getElementById('weight-log');
  const revSorted = [...sorted].reverse();
  logEl.innerHTML = revSorted.map((k,i) => {
    const prev = revSorted[i+1];
    const delta = prev ? raw[k] - raw[prev] : null;
    const deltaStr = delta !== null ? `<span class="w-entry-delta" style="color:${delta<=0?'var(--green)':'var(--red)'}">${delta>0?'+':''}${delta.toFixed(1)}kg</span>` : '';
    return `<div class="w-entry">
      <span class="w-entry-date">${new Date(k+'T12:00:00').toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})}</span>
      <span class="w-entry-val" style="color:var(--gold)">${raw[k].toFixed(1)} kg</span>
      ${deltaStr}
      <button class="w-del-btn" onclick="deleteWeight('${k}')">âœ•</button>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSONAL RECORDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderRecords() {
  const allKeys = Object.keys(localData).sort();
  const streak = calcStreak();

  // Best completion day
  let bestDay = {pct:0, key:null};
  allKeys.forEach(k => { const s=calcStats(localData[k]); if(s.pct>bestDay.pct){bestDay={pct:s.pct,key:k};} });

  // Best week avg
  let bestWeekAvg = 0, bestWeekStart = null;
  for (let i=0; i<=allKeys.length-7; i++) {
    const slice = allKeys.slice(i,i+7);
    const avg = Math.round(slice.reduce((a,k)=>a+calcStats(localData[k]).pct,0)/7);
    if (avg > bestWeekAvg) { bestWeekAvg=avg; bestWeekStart=slice[0]; }
  }

  // Longest streak ever
  let longestEver=0, curRun=0;
  allKeys.forEach(k => {
    if (calcStats(localData[k]).pct >= 80 || (localData[k].graceUsed||[]).length>0) { curRun++; longestEver=Math.max(longestEver,curRun); }
    else curRun=0;
  });

  // Best mood day
  let bestMood = {val:0, key:null};
  allKeys.forEach(k => { if((localData[k].mood||0)>bestMood.val) bestMood={val:localData[k].mood,key:k}; });

  // Total days logged
  const totalDays = allKeys.length;
  const overallAvg = totalDays ? Math.round(allKeys.reduce((a,k)=>a+calcStats(localData[k]).pct,0)/totalDays) : 0;

  const recs = [
    { trophy:'ğŸ”¥', label:'Current Streak', value: streak+'d', sub:'days â‰¥80%' },
    { trophy:'ğŸ†', label:'Longest Streak Ever', value: longestEver+'d', sub:'all time' },
    { trophy:'â­', label:'Best Single Day', value: bestDay.pct+'%', sub: bestDay.key ? new Date(bestDay.key+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : 'â€”' },
    { trophy:'ğŸ“…', label:'Best Week Avg', value: bestWeekAvg+'%', sub: bestWeekStart ? 'week of '+new Date(bestWeekStart+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : 'â€”' },
    { trophy:'ğŸ˜„', label:'Best Mood', value: bestMood.val ? 'â­'.repeat(bestMood.val) : 'â€”', sub: bestMood.key ? new Date(bestMood.key+'T12:00:00').toLocaleDateString('en-US',{month:'short',day:'numeric'}) : 'not logged yet' },
    { trophy:'ğŸ“Š', label:'Overall Average', value: overallAvg+'%', sub: `${totalDays} days logged` },
  ];

  document.getElementById('records-grid').innerHTML = recs.map(r => `
    <div class="record-card">
      <div class="record-trophy">${r.trophy}</div>
      <div class="record-label">${r.label}</div>
      <div class="record-value">${r.value}</div>
      <div class="record-sub">${r.sub}</div>
    </div>`).join('');

  renderCorrelations();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CORRELATION ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCorrelations() {
  const allKeys = Object.keys(localData).sort();
  const el = document.getElementById('correlations');

  if (allKeys.length < 5) {
    el.innerHTML = '<div class="empty-state">Log at least 5 days to unlock correlation insights.</div>';
    return;
  }

  const insights = [];

  // 1. Morning routine vs overall completion
  const morningItems = getAllCheckable().filter(i=>i.cat==='morning');
  const pairs = allKeys.map(k => {
    const d = localData[k];
    const morningDone = morningItems.filter(i=>d.checks&&d.checks[`${i.si}-${i.ii}`]).length;
    const morningPct = morningItems.length ? morningDone/morningItems.length : 0;
    const overall = calcStats(d).pct;
    return { morning: morningPct, overall };
  });
  const morningHigh = pairs.filter(p=>p.morning>=0.8);
  const morningLow  = pairs.filter(p=>p.morning<0.5);
  if (morningHigh.length >= 3 && morningLow.length >= 3) {
    const avgHigh = Math.round(morningHigh.reduce((a,p)=>a+p.overall,0)/morningHigh.length);
    const avgLow  = Math.round(morningLow.reduce((a,p)=>a+p.overall,0)/morningLow.length);
    const diff = avgHigh - avgLow;
    if (Math.abs(diff) > 10) insights.push({
      icon: 'ğŸŒ…',
      title: 'Morning Routine â†’ Overall Day',
      desc: `When you complete 80%+ of morning tasks, your overall completion is ${diff > 0 ? `${diff}% higher` : `${Math.abs(diff)}% lower`} (${avgHigh}% vs ${avgLow}%).`,
      badge: diff > 0 ? 'pos' : 'neg',
      badgeText: diff > 0 ? `+${diff}% boost` : `${diff}% drag`,
    });
  }

  // 2. Mood vs completion
  const moodPairs = allKeys.filter(k=>localData[k].mood>0).map(k=>({mood:localData[k].mood, pct:calcStats(localData[k]).pct}));
  if (moodPairs.length >= 5) {
    const highMood = moodPairs.filter(p=>p.mood>=4);
    const lowMood  = moodPairs.filter(p=>p.mood<=2);
    if (highMood.length>=2 && lowMood.length>=2) {
      const avgH = Math.round(highMood.reduce((a,p)=>a+p.pct,0)/highMood.length);
      const avgL = Math.round(lowMood.reduce((a,p)=>a+p.pct,0)/lowMood.length);
      insights.push({
        icon: 'ğŸ˜„',
        title: 'Mood â†’ Routine Completion',
        desc: `On high mood days (4â€“5â˜…) you complete ${avgH}% of your routine. On low mood days (1â€“2â˜…) it drops to ${avgL}%.`,
        badge: avgH > avgL ? 'pos' : 'neu',
        badgeText: `${avgH-avgL}% difference`,
      });
    }
  }

  // 3. Energy vs completion
  const energyPairs = allKeys.filter(k=>localData[k].energy>0).map(k=>({energy:localData[k].energy, pct:calcStats(localData[k]).pct}));
  if (energyPairs.length >= 5) {
    const highE = energyPairs.filter(p=>p.energy>=4);
    const lowE  = energyPairs.filter(p=>p.energy<=2);
    if (highE.length>=2 && lowE.length>=2) {
      const avgH = Math.round(highE.reduce((a,p)=>a+p.pct,0)/highE.length);
      const avgL = Math.round(lowE.reduce((a,p)=>a+p.pct,0)/lowE.length);
      insights.push({
        icon: 'âš¡',
        title: 'Energy Level â†’ Completion',
        desc: `High energy days average ${avgH}% completion vs ${avgL}% on low energy days.`,
        badge: avgH > avgL ? 'pos' : 'neu',
        badgeText: `${avgH-avgL}% difference`,
      });
    }
  }

  // 4. Day of week pattern
  const dowMap = {};
  allKeys.forEach(k => {
    const dow = new Date(k+'T12:00:00').getDay();
    if (!dowMap[dow]) dowMap[dow] = [];
    dowMap[dow].push(calcStats(localData[k]).pct);
  });
  const dowAvgs = Object.entries(dowMap).map(([d,vals])=>({
    day: ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d],
    avg: Math.round(vals.reduce((a,b)=>a+b,0)/vals.length),
    n: vals.length
  })).filter(d=>d.n>=2);
  if (dowAvgs.length >= 4) {
    const best  = dowAvgs.reduce((a,b)=>b.avg>a.avg?b:a);
    const worst = dowAvgs.reduce((a,b)=>b.avg<a.avg?b:a);
    insights.push({
      icon: 'ğŸ“†',
      title: 'Best & Worst Days of Week',
      desc: `You perform best on <strong>${best.day}s</strong> (avg ${best.avg}%) and struggle most on <strong>${worst.day}s</strong> (avg ${worst.avg}%). Plan accordingly.`,
      badge: 'neu',
      badgeText: 'pattern detected',
    });
  }

  // 5. Streak effect
  const streakEffect = [];
  let run=0;
  allKeys.forEach(k=>{
    const pct=calcStats(localData[k]).pct;
    if(pct>=80){run++;streakEffect.push({run,pct});}else run=0;
  });
  if(streakEffect.length>=7){
    const short=streakEffect.filter(s=>s.run<=3);
    const long=streakEffect.filter(s=>s.run>=7);
    if(short.length>=2&&long.length>=2){
      const avgS=Math.round(short.reduce((a,s)=>a+s.pct,0)/short.length);
      const avgL=Math.round(long.reduce((a,s)=>a+s.pct,0)/long.length);
      insights.push({
        icon:'ğŸ”¥',
        title:'Streak Momentum Effect',
        desc:`After 7+ consecutive strong days, your completion averages ${avgL}% vs ${avgS}% in early streak days. Momentum compounds.`,
        badge:'pos',
        badgeText:'momentum confirmed',
      });
    }
  }

  if (!insights.length) {
    el.innerHTML = '<div class="empty-state">Keep logging â€” correlations appear after more varied data.</div>';
    return;
  }

  el.innerHTML = insights.map(i=>`
    <div class="corr-card">
      <div class="corr-icon">${i.icon}</div>
      <div>
        <div class="corr-title">${i.title}</div>
        <div class="corr-desc">${i.desc}</div>
        <span class="corr-badge ${i.badge}">${i.badgeText}</span>
      </div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  setSyncStatus('syncing','loading...');
  const data=await ghGet();
  localData=data||{};
  // Set weight date picker to today
  document.getElementById('w-date').value = todayKey();
  renderToday();
  document.title=`Health OS â€” ${new Date().toLocaleDateString('en-US',{month:'short',day:'numeric'})}`;
}

function bootApp() {
  if(isConfigured()) { document.getElementById('setup-overlay').classList.add('hidden'); initApp(); }
  else { document.getElementById('setup-overlay').classList.remove('hidden'); }
}

// Start
if(isLoggedIn()) { document.getElementById('login-screen').classList.add('hidden'); bootApp(); }
</script>
</body>
</html>
